<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<title>Create | SN Design Studio</title>

<link rel="stylesheet" href="https://api.sn-designstudio.dev/assets/css/master.css">
<link rel="stylesheet" href="https://api.sn-designstudio.dev/assets/css/create.css">

</head>
<body>

<div class="create-wrapper">

<h1 class="create-title">ULTRA GOD CREATE</h1>

<div class="engine-card">

<img id="templatePreview" class="template-preview">

<h3 id="engineLabel">ENGINE: --</h3>
<p id="creditLabel">Credit: --</p>
<p id="limitLabel">Limit: --</p>

<div id="dynamicInputs"></div>

<button id="createBtn">CREATE</button>

<h3 id="statusTop">STATUS: IDLE</h3>

<div class="progress-wrap">
<div id="progressBar"></div>
</div>

</div>

<div id="preview"></div>

</div>

<script>

/*
==========================================
ULTRA GOD CREATE V4 â€” AUTO SYNC EDITION
==========================================
*/

const API = "https://api.sn-designstudio.dev";
const params = new URLSearchParams(location.search);
const templateID = params.get("template");

const engineLabel = document.getElementById("engineLabel");
const creditLabel = document.getElementById("creditLabel");
const limitLabel = document.getElementById("limitLabel");
const dynamicInputs = document.getElementById("dynamicInputs");
const progressBar = document.getElementById("progressBar");
const statusTop = document.getElementById("statusTop");

let presetData = null;

if(!templateID){
   document.body.innerHTML="TEMPLATE PARAM MISSING";
   throw new Error("Template missing");
}

/* ================= LOAD PRESET ================= */

async function loadPreset(){

   const res = await fetch(API+"/api/template/"+templateID);
   const preset = await res.json();

   presetData = preset;

   engineLabel.textContent = "ENGINE: "+preset.engine;
   creditLabel.textContent = "Credit: "+(preset.creditCost || "--");
   limitLabel.textContent =
   "Limit: Max "+(preset.limits?.maxDuration || "--")+"s";

   document.getElementById("templatePreview").src =
   API+"/assets/images/template-"+templateID+".jpg";

   buildDynamicUI(preset.input);
}

loadPreset();

/* ================= BUILD DYNAMIC UI ================= */

function buildDynamicUI(inputConfig){

   dynamicInputs.innerHTML="";

   if(inputConfig.prompt){
      dynamicInputs.innerHTML +=
      `<input id="promptInput" placeholder="Enter prompt">`;
   }

   if(inputConfig.image){
      dynamicInputs.innerHTML +=
      `<input type="file" id="imageInput" accept="image/*">`;
   }

   if(inputConfig.video){
      dynamicInputs.innerHTML +=
      `<input type="file" id="videoInput" accept="video/*">`;
   }

}

/* ================= CREATE ================= */

document.getElementById("createBtn")
.addEventListener("click", async ()=>{

   if(!presetData) return;

   const payload = {
      templateID: templateID
   };

   if(presetData.input.prompt){
      const prompt =
      document.getElementById("promptInput")?.value || "";
      if(!prompt.trim()){
         alert("Prompt required");
         return;
      }
      payload.prompt = prompt;
   }

   statusTop.textContent="STATUS: SENDING";

   const res = await fetch(API+"/api/render",{
      method:"POST",
      headers:{
         "Content-Type":"application/json"
      },
      body:JSON.stringify(payload)
   });

   const data = await res.json();

   if(!data.jobID){
      statusTop.textContent="STATUS: ERROR";
      return;
   }

   startPolling(data.jobID);
});

/* ================= POLLING ================= */

function startPolling(jobID){

   let progress=5;
   progressBar.style.width="5%";

   const loop = setInterval(async ()=>{

      const res = await fetch(API+"/api/status/"+jobID);
      const data = await res.json();

      progress+=10;
      if(progress>95) progress=95;
      progressBar.style.width=progress+"%";

      if(data.status==="complete"){

         clearInterval(loop);
         progressBar.style.width="100%";
         statusTop.textContent="STATUS: COMPLETE";

         if(data.url){
            document.getElementById("preview").innerHTML=
            '<video controls autoplay src="'+data.url+'"></video>';
         }

      }

      if(data.status==="error"){
         clearInterval(loop);
         statusTop.textContent="STATUS: ERROR";
      }

   },3000);
}

</script>

</body>
</html>
