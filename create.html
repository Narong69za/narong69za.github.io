<!DOCTYPE html>
<html lang="th">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>SN DESIGN CREATE</title>

<style>

body{
 background:#0b0b0b;
 color:white;
 font-family:Arial;
 margin:0;
}

.container{
 padding:20px;
}

button{
 background:#ff0033;
 color:white;
 border:none;
 padding:12px 20px;
 cursor:pointer;
}

img{
 max-width:100%;
}

</style>

</head>
<body>

<div class="container">

<h2 id="templateTitle">Loading Template...</h2>

<img id="previewImage" src="" />

<br><br>

<input id="promptInput" placeholder="Enter Prompt" style="width:100%;padding:10px;">

<br><br>

<button onclick="startRender()">CREATE</button>

<p id="statusText"></p>

</div>

<script>

/* ===============================
ULTRA SAFE CONFIG
=============================== */

const API_URL = "https://sn-design-api.onrender.com";

/* ===============================
SAFE PARAM CHECK
=============================== */

const params = new URLSearchParams(window.location.search);

let template = params.get("template");

/* fallback ถ้าไม่มี template */

if(!template){

 console.warn("NO TEMPLATE PARAM → using default");

 template = "dance-motion";

}

/* ===============================
LOAD TEMPLATE UI
=============================== */

function loadTemplate(){

 const title = document.getElementById("templateTitle");
 const img = document.getElementById("previewImage");

 title.innerText = "Template : " + template;

 img.src = "/assets/images/template-"+template+".jpg";

 img.onerror = ()=>{

  console.warn("preview image missing");

  img.style.display="none";

 };

}

loadTemplate();

/* ===============================
RENDER ENGINE
=============================== */

async function startRender(){

 const prompt = document.getElementById("promptInput").value;

 if(!prompt){

  alert("Enter prompt");

  return;

 }

 document.getElementById("statusText").innerText="Starting...";

 try{

   const res = await fetch(API_URL+"/api/render",{

     method:"POST",

     headers:{ "Content-Type":"application/json" },

     body:JSON.stringify({

       templateID:template,
       prompt:prompt

     })

   });

   const data = await res.json();

   if(!data.success){

     throw new Error("ENGINE FAIL");

   }

   trackStatus(data.jobID);

 }catch(err){

   console.error(err);

   document.getElementById("statusText").innerText="ERROR START ENGINE";

 }

}

/* ===============================
STATUS TRACK
=============================== */

async function trackStatus(jobID){

 const statusText = document.getElementById("statusText");

 const interval = setInterval(async()=>{

   try{

     const res = await fetch(API_URL+"/api/status/"+jobID);

     const data = await res.json();

     statusText.innerText = "Progress : "+data.progress+"%";

     if(data.status === "complete"){

       clearInterval(interval);

       statusText.innerText="DONE";

     }

   }catch(e){

     console.warn("status error");

   }

 },2000);

}

</script>

</body>
</html>
