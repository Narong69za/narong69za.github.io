<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>Create | SN Design Studio</title>

<link rel="stylesheet" href="assets/css/create.css">

</head>
<body>

<div class="create-wrapper">

  <div class="create-header">
    <div class="create-title">ULTRA GOD CREATE</div>
    <div id="engineLabel" class="engine-badge"></div>
  </div>

  <div class="create-grid">

    <div class="create-left">
      <input id="prompt" class="create-input" placeholder="Enter prompt">
      <button id="createBtn" class="create-btn">CREATE VIDEO</button>
      <div id="status" class="status-box">STATUS: IDLE</div>
    </div>

    <div class="create-right">
      <div id="preview" class="preview-box">PREVIEW AREA</div>
      <pre id="debug" class="debug-box"></pre>
    </div>

  </div>

</div>

<script>

const API = "https://api.sn-designstudio.dev";

const params = new URLSearchParams(window.location.search);
const templateID = params.get("template");

const statusEl = document.getElementById("status");
const debugEl = document.getElementById("debug");
const engineLabel = document.getElementById("engineLabel");

function log(msg){
debugEl.textContent += msg + "\\n";
}

if(!templateID){
statusEl.textContent = "STATUS: NO TEMPLATE";
throw new Error("Template missing");
}

engineLabel.textContent = "ENGINE: " + templateID;
log("Template: " + templateID);

document.getElementById("createBtn")
.addEventListener("click", async ()=>{

statusEl.textContent = "STATUS: SENDING...";
log("CTA CLICKED");

const prompt =
document.getElementById("prompt").value;

try{

const res = await fetch(API + "/api/render", {
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify({
templateID: templateID,
prompt: prompt
})
});

const data = await res.json();
log("Response: " + JSON.stringify(data));

if(!data.jobID){
throw new Error("No jobID");
}

statusEl.textContent = "STATUS: PROCESSING";
pollStatus(data.jobID);

}catch(e){
statusEl.textContent = "STATUS: ERROR";
log("ERROR: " + e.message);
}

});

function pollStatus(jobID){

const interval = setInterval(async()=>{

const res = await fetch(API + "/api/status/" + jobID);
const data = await res.json();

log("Progress: " + data.progress);

if(data.status === "complete"){
clearInterval(interval);
statusEl.textContent = "STATUS: COMPLETE";
showPreview(data.url);
}

if(data.status === "error"){
clearInterval(interval);
statusEl.textContent = "STATUS: ERROR";
}

},3000);

}

function showPreview(url){
if(!url) return;
document.getElementById("preview").innerHTML =
'<video controls autoplay src="'+url+'"></video>';
}

</script>

</body>
</html>
