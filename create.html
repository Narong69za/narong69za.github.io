<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<title>Create | SN Design Studio</title>

<link rel="stylesheet" href="https://api.sn-designstudio.dev/assets/css/master.css">
<link rel="stylesheet" href="https://api.sn-designstudio.dev/assets/css/create.css">

</head>
<body>

<div class="create-wrapper">

<h1 class="create-title">ULTRA GOD CREATE</h1>

<!-- ================= TOP ENGINE CARD ================= -->

<div class="engine-card">

<img id="templatePreview" class="template-preview">

<h3 id="engineLabel">ENGINE: --</h3>

<p>User: SN USER</p>

<p id="creditLabel">Credit: --</p>

<p id="limitLabel">Limit: --</p>

<button id="uploadBtn">UPLOAD MEDIA</button>

<input type="file" id="uploadMedia" hidden>

<h3 id="statusTop">STATUS: IDLE</h3>

<div class="progress-wrap">
<div id="progressBar"></div>
</div>

</div>


<!-- ================= INPUT ================= -->

<input id="prompt" placeholder="Enter prompt">

<button id="createBtn">CREATE VIDEO</button>

<h3 id="status">STATUS: IDLE</h3>

<div id="preview"></div>

</div>


<script>

/*
====================================
ULTRA GOD CREATE CORE
FINAL PRODUCTION VERSION
====================================
*/

const API = "https://api.sn-designstudio.dev";

const params = new URLSearchParams(location.search);
const templateID = params.get("template");

const engineLabel = document.getElementById("engineLabel");
const creditLabel = document.getElementById("creditLabel");
const limitLabel = document.getElementById("limitLabel");
const templatePreview = document.getElementById("templatePreview");

const promptInput = document.getElementById("prompt");
const createBtn = document.getElementById("createBtn");

const progressBar = document.getElementById("progressBar");
const statusTop = document.getElementById("statusTop");

const uploadBtn = document.getElementById("uploadBtn");
const uploadMedia = document.getElementById("uploadMedia");

if(!templateID){

document.body.innerHTML="TEMPLATE PARAM MISSING";

throw new Error("Template missing");

}

/* ================= LOAD PRESET ================= */

async function loadPreset(){

try{

const res = await fetch(API+"/api/template/"+templateID);

const preset = await res.json();

engineLabel.textContent = "ENGINE: "+preset.engine;

limitLabel.textContent =
"Limit: Max "+(preset.limits?.maxDuration || "--")+"s";

creditLabel.textContent =
"Credit: "+(preset.creditCost || "--");

/* preview image from template */

templatePreview.src =
API+"/assets/images/template-"+templateID+".jpg";

}catch(e){

engineLabel.textContent="PRESET LOAD ERROR";

}

}

loadPreset();


/* ================= UPLOAD ================= */

uploadBtn.onclick = ()=>{

uploadMedia.click();

};


/* ================= PROGRESS ================= */

function setProgress(val){

progressBar.style.width = val+"%";

}


/* ================= CREATE ================= */

createBtn.addEventListener("click", async ()=>{

const prompt = promptInput.value || "";

if(!prompt.trim()){

alert("Enter prompt first");
return;

}

document.getElementById("status").textContent="STATUS: SENDING";
statusTop.textContent="STATUS: SENDING";

try{

const res = await fetch(API+"/api/render",{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({

templateID:templateID,
prompt:prompt   // ⭐ FIX สำคัญ

})

});

const data = await res.json();

if(!data.jobID) throw new Error("NO JOB ID");

startPolling(data.jobID);

}catch(e){

document.getElementById("status").textContent="STATUS: ERROR";
statusTop.textContent="STATUS: ERROR";

}

});


/* ================= POLLING ================= */

function startPolling(jobID){

let progress = 5;

setProgress(progress);

const loop = setInterval(async ()=>{

try{

const res = await fetch(API+"/api/status/"+jobID);

const data = await res.json();

progress += 10;

if(progress>95) progress=95;

setProgress(progress);

if(data.status==="complete"){

clearInterval(loop);

setProgress(100);

document.getElementById("status").textContent="STATUS: COMPLETE";

statusTop.textContent="STATUS: COMPLETE";

if(data.url){

document.getElementById("preview").innerHTML =
'<video controls autoplay src="'+data.url+'"></video>';

}

}

if(data.status==="error"){

clearInterval(loop);

document.getElementById("status").textContent="STATUS: ERROR";

statusTop.textContent="STATUS: ERROR";

}

}catch(e){}

},3000);

}

</script>

</body>
</html>
