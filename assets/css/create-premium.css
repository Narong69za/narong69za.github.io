/*
=====================================
ULTRA CREATE PREMIUM FINAL
SN DESIGN STUDIO
STATIC LOCK FLOW
=====================================
*/

const API="https://sn-design-api.onrender.com";

let CURRENT_PRESET=null;

init();

async function init(){

   loadPreset();

}

/*
=====================================
STATIC PRESET (NO API CALL)
=====================================
*/

function loadPreset(){

   const params=new URLSearchParams(location.search);

   const id=params.get("template");

   if(!id){

      setEngine("UNKNOWN");

      return;

   }

   /* STATIC MAP */

   const STATIC_PRESETS={

      "dark-viral":{
         id:"dark-viral",
         ui:{needPrompt:true}
      },

      "lipsync":{
         id:"lipsync",
         ui:{needPrompt:true}
      },

      "dance-motion":{
         id:"dance-motion",
         ui:{needPrompt:true}
      },

      "face-swap":{
         id:"face-swap",
         ui:{needPrompt:true}
      }

   };

   const preset=STATIC_PRESETS[id];

   if(!preset){

      setEngine("UNKNOWN");

      return;

   }

   CURRENT_PRESET=preset;

   buildUI(preset);

}

/*
=====================================
BUILD UI
=====================================
*/

function buildUI(p){

   setEngine(p.id || "UNKNOWN");

   toggle("promptBox",p.ui?.needPrompt);

}

/*
=====================================
SET ENGINE LABEL
=====================================
*/

function setEngine(name){

   const el=document.getElementById("engineName");

   if(el){

      el.innerText="ENGINE: "+name;

   }

}

/*
=====================================
SHOW / HIDE UI BLOCK
=====================================
*/

function toggle(id,state){

   const el=document.getElementById(id);

   if(!el) return;

   if(state) el.classList.remove("hidden");
   else el.classList.add("hidden");

}

/*
=====================================
CTA GENERATE
=====================================
*/

const btn=document.getElementById("generateBtn");

if(btn){

   btn.onclick=async()=>{

      if(!CURRENT_PRESET) return;

      setStatus("PROCESSING");

      simulateProgress();

      try{

         const res=await fetch(API+"/api/render",{

            method:"POST",

            headers:{
               "Content-Type":"application/json"
            },

            body:JSON.stringify({

               preset:CURRENT_PRESET.id,

               model: window.getSelectedModel ? window.getSelectedModel() : null,

               prompt:document.getElementById("promptBox")?.value || ""

            })

         });

         const data=await res.json();

         console.log("RENDER RESULT:",data);

         if(data.success){

            setStatus("COMPLETE");

            setProgress(100);

         }else{

            setStatus("FAILED");

         }

      }catch(e){

         console.error(e);

         setStatus("ERROR");

      }

   };

}

/*
=====================================
STATUS + PROGRESS
=====================================
*/

function setStatus(text){

   const el=document.getElementById("statusText");

   if(el){

      el.innerText="STATUS: "+text;

   }

}

function simulateProgress(){

   let progress=0;

   const interval=setInterval(()=>{

      progress+=10;

      if(progress>=90){

         clearInterval(interval);

      }

      setProgress(progress);

   },300);

}

function setProgress(val){

   const bar=document.getElementById("progressBar");

   if(bar){

      bar.style.width=val+"%";

   }

      }
/*
=====================================
ULTRA CONTROL STATE SYSTEM
ADD ONLY
=====================================
*/

let CURRENT_ACTION = null;

/*
=====================================
ACTION SELECT (TOP MENU)
=====================================
*/

const ACTION_BUTTONS = document.querySelectorAll(".action-btn");

ACTION_BUTTONS.forEach(btn=>{

   btn.onclick=()=>{

      CURRENT_ACTION = btn.dataset.action;

      ACTION_BUTTONS.forEach(b=>b.classList.remove("active-green"));

      btn.classList.add("active-green");

      updatePreviewLabel();

   };

});


/*
=====================================
PREVIEW FILE SYSTEM
=====================================
*/

const fileInput = document.getElementById("fileInput");

if(fileInput){

fileInput.onchange=(e)=>{

   const file = e.target.files[0];

   if(!file) return;

   const previewBox = document.getElementById("previewArea");

   previewBox.innerHTML="";

   const url = URL.createObjectURL(file);

   if(file.type.startsWith("video")){

      const video=document.createElement("video");

      video.src=url;
      video.controls=true;
      video.autoplay=true;
      video.loop=true;
      video.style.width="100%";

      previewBox.appendChild(video);

   }
   else if(file.type.startsWith("image")){

      const img=document.createElement("img");

      img.src=url;
      img.style.width="100%";

      previewBox.appendChild(img);

   }

};

}


/*
=====================================
UPDATE LABEL
=====================================
*/

function updatePreviewLabel(){

   const label=document.getElementById("previewMeta");

   if(!label) return;

   label.innerText = `
ENGINE: ${CURRENT_ENGINE || "-"}
| MODE: ${CURRENT_MODE || "-"}
| TYPE: ${CURRENT_ACTION || "-"}
`;

      }
